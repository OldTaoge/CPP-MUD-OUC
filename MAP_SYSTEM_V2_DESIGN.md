# 地图系统V2设计文档

## 设计概述

重新设计了地图系统，采用独立的9x9区块设计，每个区块独立呈现，多个区块间一维拼接，用户可在区块中移动并切换区块。

## 核心设计理念

### 1. 独立区块系统
- 每个区块大小固定为9x9网格
- 每个区块独立管理自己的内容和交互
- 区块间通过出口进行连接

### 2. 网格化移动
- 玩家在9x9网格中移动
- 每个网格单元可以有不同的类型和交互
- 支持墙壁、物品、NPC、怪物等多种元素

### 3. 区块切换机制
- 玩家移动到出口时自动切换区块
- 支持北、南、东、西四个方向的出口
- 切换时自动调整玩家在新区块中的位置

## 技术架构

### 核心类结构

```
MapManagerV2 (地图管理器)
├── MapBlock (区块基类)
│   ├── TutorialBlock (教学区块)
│   ├── StatueOfSevenBlock (七天神像区块)
│   ├── SlimeBattleBlock (史莱姆战斗区块)
│   ├── AmberDialogueBlock (安伯对话区块)
│   └── MondstadtCityBlock (蒙德城区块)
└── MapCell (地图单元格)
```

### 地图单元格类型

```cpp
enum class CellType {
    EMPTY,      // 空地 "."
    WALL,       // 墙壁 "#"
    PLAYER,     // 玩家 "P"
    ITEM,       // 物品 "I"
    NPC,        // NPC "A"/"K"
    STATUE,     // 神像 "S"
    MONSTER,    // 怪物 "M"
    EXIT_NORTH, // 北出口 "^"
    EXIT_SOUTH, // 南出口 "v"
    EXIT_EAST,  // 东出口 ">"
    EXIT_WEST   // 西出口 "<"
};
```

## 区块设计

### 区块0: 新手教学区
```
# # # # # # # # #
# . . . . . . . #
# . . . . . . . #
# . . I . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# # # # > # # # #
```
- 位置(3,3): 苹果物品
- 位置(8,4): 东出口 → 区块1

### 区块1: 七天神像（风）
```
# # # # # # # # #
# . . . . . . . #
# . . . . . . . #
# . . . S . C . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
< # # # v # # # #
```
- 位置(4,3): 七天神像
- 位置(6,3): 宝箱
- 位置(0,4): 西出口 → 区块0
- 位置(4,8): 南出口 → 区块2

### 区块2: 史莱姆栖息地
```
# # # # ^ # # # #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . M . . #
# . . . . . . . #
# . . . . . . . #
# # # # # # # # >
```
- 位置(5,5): 史莱姆怪物
- 位置(4,0): 北出口 → 区块1
- 位置(8,4): 东出口 → 区块3

### 区块3: 安伯的营地
```
# # # # # # # # #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . A . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
< # # # v # # # #
```
- 位置(6,4): 安伯NPC
- 位置(0,4): 西出口 → 区块2
- 位置(4,8): 南出口 → 区块4

### 区块4: 蒙德城
```
# # # # ^ # # # #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . . . . #
# . . . . K . . #
# . . . . . . . #
# # # # # # # # #
```
- 位置(5,6): 凯亚NPC
- 位置(4,0): 北出口 → 区块3

## 功能特性

### 1. 区块内移动
- 使用W/A/S/D或方向键移动
- 自动碰撞检测（墙壁阻挡）
- 实时位置更新

### 2. 区块间切换
- 移动到出口自动切换区块
- 根据出口方向确定新区块中的起始位置
- 无缝的区块转换体验

### 3. 交互系统
- 每个单元格可以有多种交互类型
- 支持拾取、战斗、对话、激活等交互
- 交互结果可以影响区块状态

### 4. 渲染系统
- 实时渲染当前9x9区块
- 玩家位置用"P"标记
- 不同元素有不同的符号表示

## API接口

### MapManagerV2 主要方法

```cpp
// 区块管理
bool switchToBlock(int blockId, int startX = 4, int startY = 4);
std::shared_ptr<MapBlock> getCurrentBlock() const;
int getCurrentBlockId() const;

// 玩家移动
bool movePlayer(int deltaX, int deltaY);
std::pair<int, int> getPlayerPosition() const;

// 交互系统
InteractionResult interactWithCurrentCell(Player& player, InteractionType type);
std::vector<InteractionType> getAvailableInteractions() const;

// 渲染系统
std::vector<std::string> renderCurrentBlock() const;
std::string getCurrentCellInfo() const;
std::string getBlockInfo() const;
```

### MapBlock 主要方法

```cpp
// 网格操作
MapCell& getCell(int x, int y);
void setCell(int x, int y, const MapCell& cell);
bool isValidPosition(int x, int y) const;

// 移动系统
bool canMoveTo(int x, int y) const;
bool movePlayer(int deltaX, int deltaY);

// 出口系统
bool isExit(int x, int y) const;
int getExitTarget(int x, int y) const;
```

## 游戏流程

### 线性探索路径
1. **教学区块 (0)** → 学习基本操作
2. **七天神像区块 (1)** → 激活神像，获得宝箱
3. **史莱姆区块 (2)** → 战斗训练
4. **安伯营地 (3)** → 招募安伯
5. **蒙德城 (4)** → 招募凯亚

### 区块连接图
```
[0] → [1] → [2] → [3] → [4]
 ↑     ↓     ↑     ↓     ↑
教学   神像   史莱姆  安伯   蒙德
```

## 优势特点

### 1. 模块化设计
- 每个区块独立开发和测试
- 易于添加新区块
- 区块间松耦合

### 2. 清晰的空间结构
- 固定的9x9大小便于设计和理解
- 网格化移动精确可控
- 视觉呈现清晰

### 3. 扩展性强
- 支持任意数量的区块
- 可以创建复杂的区块连接关系
- 交互系统高度可定制

### 4. 性能优化
- 只渲染当前区块
- 内存使用效率高
- 区块切换快速流畅

## 使用方法

### 基本操作
- **移动**: W/A/S/D 或方向键
- **交互**: 空格键
- **查看信息**: 实时显示在界面上

### 区块切换
- 移动到区块边缘的出口符号
- 自动切换到连接的区块
- 在新区块中从对应位置开始

### 交互流程
1. 移动到有交互元素的位置
2. 按空格键查看可用交互
3. 选择交互类型
4. 查看交互结果

## 总结

新的地图系统V2提供了更加结构化和模块化的游戏世界设计，通过9x9区块的独立设计和区块间的连接机制，创造了一个既有组织又有探索乐趣的游戏环境。系统设计灵活，易于扩展，为后续的游戏内容开发提供了坚实的基础。
